#!/bin/bash

clear
echo "
   ____   __  __   ____  
  / ___| |  \/  | |  _ \ 
 | |  _  | |\/| | | | | |
 | |_| | | |  | | | |_| |
  \____| |_|  |_| |____/ 
-------------------------
   GNU MEDIA DOWNLOADER
-------------------------
       Â» BY GNUTUX Â«
          Â» v1.0 Â«

"
# âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
REQUIRED_CMDS=(ffmpeg yt-dlp zenity)
missing=()

for cmd in "${REQUIRED_CMDS[@]}"; do
    if ! command -v "$cmd" &>/dev/null; then
        missing+=("$cmd")
    fi
done

if (( ${#missing[@]} > 0 )); then
    msg="âŒ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©:\n"
    for m in "${missing[@]}"; do
        msg+="â€¢ $m\n"
    done
    msg+="\nÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØªÙ‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§."

    if command -v zenity &>/dev/null; then
        zenity --error --title="Ù†Ù‚Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª" --text="$msg"
    else
        echo -e "$msg"
    fi

    exit 1
fi



# âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„ØºØ©
LANGUAGE=$(locale | grep LANG= | cut -d= -f2 | cut -d_ -f1)
if [[ "$LANGUAGE" == "ar" ]]; then
  L=ar
else
  L=en
fi

# âœ… Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
YTDLP=$(command -v yt-dlp || command -v youtube-dl)
FFMPEG=$(command -v ffmpeg)
FILE_MANAGER=$(command -v xdg-open || command -v nemo || command -v nautilus)
SAVE_PATH=""

if [[ -z "$YTDLP" || -z "$FFMPEG" ]]; then
  echo "âŒ Please install yt-dlp (or youtube-dl) and ffmpeg first." && exit 1
fi

# âœ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­ÙØ¸
choose_save_path() {
  if [[ "$L" == "ar" ]]; then
    echo "ğŸ“ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙƒØ§Ù† Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù..."
  else
    echo "ğŸ“ Please select a save location..."
  fi
  SAVE_PATH=$(zenity --file-selection --directory --title="Choose download folder")
  if [[ -z "$SAVE_PATH" ]]; then
    echo "âŒ No folder selected."
    exit 1
  fi
}

# âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬ÙˆØ¯Ø©
choose_quality() {
  if [[ "$L" == "ar" ]]; then
    echo "ğŸï¸ Ø§Ø®ØªØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:"
    echo "1) Ø¹Ø§Ù„ÙŠØ©"
    echo "2) Ù…ØªÙˆØ³Ø·Ø©"
    echo "3) Ù…Ù†Ø®ÙØ¶Ø©"
  else
    echo "ğŸï¸ Select video quality:"
    echo "1) High"
    echo "2) Medium"
    echo "3) Low"
  fi
  read -p "â¤ " quality

  case $quality in
    1) FORMAT="bestvideo+bestaudio/best";;
    2) FORMAT="bv[height<=720]+ba/best[height<=720]";;
    3) FORMAT="bv[height<=480]+ba/best[height<=480]";;
    *) echo "âŒ Invalid choice."; return 1;;
  esac
  return 0
}

# âœ… Ø§Ø®ØªÙŠØ§Ø± ØµÙŠØºØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„
choose_conversion_format() {
  if [[ "$L" == "ar" ]]; then
    echo "ğŸ§ Ø§Ø®ØªØ± ØµÙŠØºØ© Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬:"
    echo "1) mp3"
    echo "2) mp4"
    echo "3) webm"
    echo "4) mkv"
    echo "5) wav"
    echo "6) flac"
  else
    echo "ğŸ§ Choose output format:"
    echo "1) mp3"
    echo "2) mp4"
    echo "3) webm"
    echo "4) mkv"
    echo "5) wav"
    echo "6) flac"
  fi
  read -p "â¤ " conv_format

  case $conv_format in
    1) EXT="mp3";;
    2) EXT="mp4";;
    3) EXT="webm";;
    4) EXT="mkv";;
    5) EXT="wav";;
    6) EXT="flac";;
    *) echo "âŒ Invalid choice."; return 1;;
  esac
  return 0
}

# âœ… Ø§Ø®ØªÙŠØ§Ø± ØµÙŠØºØ© Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙƒØµÙˆØª
choose_audio_format() {
  if [[ "$L" == "ar" ]]; then
    echo "ğŸ”Š Ø§Ø®ØªØ± ØµÙŠØºØ© Ø§Ù„ØµÙˆØª:"
    echo "1) mp3"
    echo "2) m4a"
    echo "3) opus"
    echo "4) flac"
    echo "5) wav"
  else
    echo "ğŸ”Š Choose audio format:"
    echo "1) mp3"
    echo "2) m4a"
    echo "3) opus"
    echo "4) flac"
    echo "5) wav"
  fi
  read -p "â¤ " audio_format
  case $audio_format in
    1) AUDIO_OPTS="--extract-audio --audio-format mp3";;
    2) AUDIO_OPTS="--extract-audio --audio-format m4a";;
    3) AUDIO_OPTS="--extract-audio --audio-format opus";;
    4) AUDIO_OPTS="--extract-audio --audio-format flac";;
    5) AUDIO_OPTS="--extract-audio --audio-format wav";;
    *) AUDIO_OPTS="";;
  esac
}

# âœ… Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ø¹Ø¨Ø± Ø£Ø±Ù‚Ø§Ù…
get_advanced_options() {
  if [[ "$L" == "ar" ]]; then
    echo "â• Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø®ÙŠØ§Ø± Ù…ÙØµÙˆÙ„ Ø¨ÙØ§ØµÙ„Ø©):"
    echo "1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø©"
    echo "2) ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©"
    echo "3) ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"
    echo "4) ØªØ­Ù…ÙŠÙ„ ÙƒØµÙˆØª"
    echo "5) Ù„Ø§ Ø´ÙŠØ¡"
  else
    echo "â• Choose advanced options (you can select multiple, e.g., 1,2):"
    echo "1) Download thumbnail"
    echo "2) Download subtitles"
    echo "3) Ignore errors"
    echo "4) Download as audio"
    echo "5) None"
  fi

  read -p "â¤ " adv_opts
  EXTRA_OPTS=""
  AUDIO_OPTS=""

  IFS=',' read -ra CHOICES <<< "$adv_opts"
  for opt in "${CHOICES[@]}"; do
    case "$opt" in
      1) EXTRA_OPTS+=" --write-thumbnail";;
      2) EXTRA_OPTS+=" --write-auto-sub";;
      3) EXTRA_OPTS+=" --ignore-errors";;
      4) choose_audio_format;;
      5) EXTRA_OPTS+="";;
    esac
  done
}

# âœ… ØªÙ†Ø²ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ
download_video() {
  read -p "ğŸŒ URL: " URL
  choose_save_path || return
  choose_quality || return
  get_advanced_options

  $YTDLP $EXTRA_OPTS $AUDIO_OPTS -f "$FORMAT" -o "$SAVE_PATH/%(title)s.%(ext)s" "$URL"
  echo "âœ… Done."
  $FILE_MANAGER "$SAVE_PATH"
}

# âœ… ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù
convert_media() {
  FILE=$(zenity --file-selection --title="Choose file to convert")
  if [[ -z "$FILE" ]]; then echo "âŒ No file selected."; return; fi
  choose_save_path || return
  choose_conversion_format || return
  BASENAME=$(basename "$FILE")
  NAME="${BASENAME%.*}"

  $FFMPEG -i "$FILE" "$SAVE_PATH/${NAME}.${EXT}"
  echo "âœ… Conversion done."
  $FILE_MANAGER "$SAVE_PATH"
}

# âœ… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
while true; do
  if [[ "$L" == "ar" ]]; then
    echo "ğŸ¬ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„"
    echo "1) ØªÙ†Ø²ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ"
    echo "2) ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù ÙˆØ³Ø§Ø¦Ø·"
    echo "3) Ø®Ø±ÙˆØ¬"
  else
    echo "ğŸ¬ Download & Convert Tool"
    echo "1) Download Video"
    echo "2) Convert Media File"
    echo "3) Exit"
  fi

  read -p "â¤ " option
  case $option in
    1) download_video;;
    2) convert_media;;
    3) echo "ğŸ‘‹"; exit 0;;
    *) echo "âŒ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­ / Invalid choice.";;
  esac
done
